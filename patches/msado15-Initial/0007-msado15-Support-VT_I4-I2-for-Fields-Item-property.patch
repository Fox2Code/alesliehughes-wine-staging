From 2df1ef62d40912a5be732e29e2f5339bf76853f6 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Wed, 17 Mar 2021 16:20:08 +1100
Subject: [PATCH v3 2/2] msado15: Support VT_I4/I2 for Fields Item property

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/msado15/recordset.c     | 16 ++++++++++++++++
 dlls/msado15/tests/msado15.c | 17 +++++++++++++++++
 2 files changed, 33 insertions(+)

diff --git a/dlls/msado15/recordset.c b/dlls/msado15/recordset.c
index e2f2e6407fd..2b752694fb8 100644
--- a/dlls/msado15/recordset.c
+++ b/dlls/msado15/recordset.c
@@ -601,6 +601,22 @@ static HRESULT map_index( struct fields *fields, VARIANT *index, ULONG *ret )
 {
     ULONG i;
 
+    if (V_VT( index ) == VT_I4 || V_VT( index ) == VT_I2)
+    {
+        if (V_VT( index ) == VT_I4)
+            i = V_I4 ( index );
+        else
+            i = V_I2 ( index );
+
+        if (i < fields->count)
+        {
+            *ret = i;
+            return S_OK;
+        }
+
+        return MAKE_ADO_HRESULT(adErrItemNotFound);
+    }
+
     if (V_VT( index ) != VT_BSTR)
     {
         FIXME( "variant type %u not supported\n", V_VT( index ) );
diff --git a/dlls/msado15/tests/msado15.c b/dlls/msado15/tests/msado15.c
index 28d5412297d..93d1dc4c19b 100644
--- a/dlls/msado15/tests/msado15.c
+++ b/dlls/msado15/tests/msado15.c
@@ -169,6 +169,23 @@ static void test_Recordset(void)
     hr = Fields__Append( fields, name, adInteger, 4, adFldUnspecified );
     ok( hr == S_OK, "got %08x\n", hr );
 
+    V_VT( &index ) = VT_I4;
+    V_I4( &index ) = 1000;
+    hr = Fields_get_Item( fields, index, &field );
+    ok( hr == MAKE_ADO_HRESULT(adErrItemNotFound), "got %08x\n", hr );
+
+    V_VT( &index ) = VT_I4;
+    V_I4( &index ) = 0;
+    hr = Fields_get_Item( fields, index, &field );
+    ok( hr == S_OK, "got %08x\n", hr );
+    Field_Release(field);
+
+    V_VT( &index ) = VT_I2;
+    V_I4( &index ) = 0;
+    hr = Fields_get_Item( fields, index, &field );
+    ok( hr == S_OK, "got %08x\n", hr );
+    Field_Release(field);
+
     V_VT( &index ) = VT_BSTR;
     V_BSTR( &index ) = name;
     hr = Fields_get_Item( fields, index, &field );
-- 
2.30.1

