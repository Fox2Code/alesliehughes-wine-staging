From c688e2ee47118cf69460c4a2f18d5e1d979c69a6 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Sat, 10 Oct 2020 15:02:32 +1100
Subject: [PATCH 1/3] msado15: Add Open Test

---
 dlls/msado15/tests/msado15.c | 61 ++++++++++++++++++++++++++++++++++++
 1 file changed, 61 insertions(+)

diff --git a/dlls/msado15/tests/msado15.c b/dlls/msado15/tests/msado15.c
index adf9fb30bc2..27c459c8888 100644
--- a/dlls/msado15/tests/msado15.c
+++ b/dlls/msado15/tests/msado15.c
@@ -1126,6 +1126,66 @@ static void test_ConnectionPoint(void)
     ok( !conn_event.refs, "got %d\n", conn_event.refs );
 }
 
+static void test_connection_open(void)
+{
+    HRESULT hr;
+    _Connection *connection;
+    _Recordset  *recordset, *recordset2 = NULL;
+    BSTR str, str2;
+    VARIANT var, var2;
+    VARIANT affected;
+
+    hr = CoCreateInstance(&CLSID_Connection, NULL, CLSCTX_INPROC_SERVER, &IID__Connection, (void**)&connection);
+    ok( hr == S_OK, "got %08x\n", hr );
+
+    hr = CoCreateInstance(&CLSID_Recordset, NULL, CLSCTX_INPROC_SERVER, &IID__Recordset, (void**)&recordset);
+    ok( hr == S_OK, "got %08x\n", hr );
+
+    str = SysAllocString(L"Provider=MSDASQL.1;Persist Security Info=False;Data Source=wine_test");
+    str2 = SysAllocStringLen(NULL, 0);
+
+    hr = _Connection_Open(connection, str, str2, str2, 0);
+    ok( hr == S_OK, "got %08x\n", hr );
+    SysFreeString(str);
+    SysFreeString(str2);
+
+    V_VT(&var2) = VT_BSTR;
+    V_BSTR(&var2) = SysAllocString(L"SELECT * FROM testing");
+
+    //V_VT(&var) = VT_DISPATCH;
+    //V_DISPATCH(&var) = (IDispatch*)connection;
+    //_Connection_AddRef(connection);
+
+    /*ok( 0, "Before _Recordset_Open\n");
+    hr = _Recordset_Open(recordset, var2, var, adOpenDynamic, adLockPessimistic, adCmdText);
+    ok( hr == S_OK, "got %08x\n", hr );
+    ok( 0, "After _Recordset_Open\n");*/
+
+    VariantInit(&affected);
+    ok( 0, "**** Before _Connection_Execute\n");
+    hr = _Connection_Execute(connection, V_BSTR(&var2), &affected, 0, &recordset2);
+    ok( 0, "**** After _Connection_Execute\n");
+    ok( hr == S_OK, "got %08x\n", hr );
+
+    if (recordset2)
+    {
+        ok(0, "Affected %d\n", V_VT(&affected));
+        hr = _Recordset_Close(recordset2);
+        ok( hr == S_OK, "got %08x\n", hr );
+
+        _Recordset_Release(recordset2);
+    }
+
+    VariantClear(&var);
+    VariantClear(&var2);
+    SysFreeString(str);
+
+     //hr = _Recordset_Close(recordset);
+     //ok( hr == S_OK, "got %08x\n", hr );
+
+    _Connection_Release(connection);
+}
+
 START_TEST(msado15)
 {
     CoInitialize( NULL );
@@ -1135,5 +1195,6 @@ START_TEST(msado15)
     test_Recordset();
     test_Stream();
     test_Command();
+    test_connection_open();
     CoUninitialize();
 }
-- 
2.28.0

