From 478b991a13791007a859f6d77a6eb5364a64df54 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Tue, 5 Jan 2016 09:55:09 +1100
Subject: [PATCH 10/12] msado15: Implement _Connection Open

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/msado15/Makefile.in  |  1 +
 dlls/msado15/connection.c | 40 ++++++++++++++++++++++++++++++++++++----
 dlls/msado15/msado15.c    |  1 +
 3 files changed, 38 insertions(+), 4 deletions(-)

diff --git a/dlls/msado15/Makefile.in b/dlls/msado15/Makefile.in
index 1754dcc..fba24df 100644
--- a/dlls/msado15/Makefile.in
+++ b/dlls/msado15/Makefile.in
@@ -1,4 +1,5 @@
 MODULE    = msado15.dll
+IMPORTS   = ole32
 
 
 C_SRCS = \
diff --git a/dlls/msado15/connection.c b/dlls/msado15/connection.c
index e159671..80b7e2f 100644
--- a/dlls/msado15/connection.c
+++ b/dlls/msado15/connection.c
@@ -28,6 +28,8 @@
 
 #include "wine/debug.h"
 
+#include "msdasc.h"
+#include "oledb.h"
 #include "msado15.h"
 #include "msado15_private.h"
 
@@ -36,6 +38,8 @@ WINE_DEFAULT_DEBUG_CHANNEL(msado);
 typedef struct
 {
     _Connection _Connection_iface;
+    IDataInitialize *datainit;
+    IDBInitialize   *dbinit;
 
     ObjectStateEnum state;
     long timeout;
@@ -90,7 +94,14 @@ static ULONG WINAPI connection_Release(_Connection *iface)
 
     ref = InterlockedDecrement(&This->ref);
     if(ref == 0)
+    {
+        if(This->dbinit)
+            IDBInitialize_Release(This->dbinit);
+        if(This->datainit)
+            IDataInitialize_Release(This->datainit);
+
         heap_free(This);
+    }
 
     return ref;
 }
@@ -248,10 +259,29 @@ static HRESULT WINAPI connection_Open(_Connection *iface, BSTR connectionstring,
         BSTR password, LONG options)
 {
     connection *This = impl_from_Connection(iface);
-    FIXME("(%p)->(%s %s %s %d)\n", This, debugstr_w(connectionstring), debugstr_w(userid),
-	        debugstr_w(password), options);
+    HRESULT hr;
 
-    return E_NOTIMPL;
+    TRACE("(%p)->(%s %s %s %d)\n", This, debugstr_w(connectionstring), debugstr_w(userid),
+            debugstr_w(password), options);
+
+    hr = CoCreateInstance(&CLSID_MSDAINITIALIZE, NULL, CLSCTX_INPROC_SERVER, &IID_IDataInitialize,(void**)&This->datainit);
+    if(FAILED(hr))
+        return hr;
+
+    hr = IDataInitialize_GetDataSource(This->datainit, NULL, CLSCTX_INPROC_SERVER, connectionstring,
+        &IID_IDBInitialize, (IUnknown**)&This->dbinit);
+    if(FAILED(hr))
+    {
+        WARN("Failed to create IDBInitialize object\n");
+
+        IDataInitialize_Release(This->datainit);
+        This->datainit = NULL;
+        return hr;
+    }
+
+    This->state = adStateOpen;
+
+    return hr;
 }
 
 static HRESULT WINAPI connection_get_Errors(_Connection *iface, Errors **errors)
@@ -443,8 +473,10 @@ HRESULT Connecton_create(void **out)
     This->ref = 1;
     This->state = adStateClosed;
     This->timeout = 30;
+    This->datainit = NULL;
+    This->dbinit   = NULL;
 
     *out = &This->_Connection_iface;
 
     return S_OK;
-}
\ No newline at end of file
+}
diff --git a/dlls/msado15/msado15.c b/dlls/msado15/msado15.c
index 07a642f..6b0b9e0 100644
--- a/dlls/msado15/msado15.c
+++ b/dlls/msado15/msado15.c
@@ -24,6 +24,7 @@
 #include "initguid.h"
 #include "windef.h"
 #include "winbase.h"
+#include "msdasc.h"
 #include "ole2.h"
 #include "rpcproxy.h"
 #include "wine/debug.h"
-- 
1.9.1

