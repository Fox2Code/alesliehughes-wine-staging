From 4fcdae4f7d8919cc7bb5291038dc444b1412497b Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Thu, 19 Dec 2019 14:04:05 +1100
Subject: [PATCH 05/11] msdasql/tests: Initial tests

---
 configure                      |  1 +
 configure.ac                   |  1 +
 dlls/msdasql/tests/Makefile.in |  6 +++
 dlls/msdasql/tests/provider.c  | 82 ++++++++++++++++++++++++++++++++++
 4 files changed, 90 insertions(+)
 create mode 100644 dlls/msdasql/tests/Makefile.in
 create mode 100644 dlls/msdasql/tests/provider.c

diff --git a/configure b/configure
index b798739b95..e483287171 100755
--- a/configure
+++ b/configure
@@ -20841,6 +20841,7 @@ wine_fn_config_makefile dlls/msctf/tests enable_tests
 wine_fn_config_makefile dlls/msctfp enable_msctfp
 wine_fn_config_makefile dlls/msdaps enable_msdaps
 wine_fn_config_makefile dlls/msdasql enable_msdasql
+wine_fn_config_makefile dlls/msdasql/tests enable_tests
 wine_fn_config_makefile dlls/msdelta enable_msdelta
 wine_fn_config_makefile dlls/msdmo enable_msdmo
 wine_fn_config_makefile dlls/msdmo/tests enable_tests
diff --git a/configure.ac b/configure.ac
index f64e860e14..04bfbac234 100644
--- a/configure.ac
+++ b/configure.ac
@@ -3463,6 +3463,7 @@ WINE_CONFIG_MAKEFILE(dlls/msctf/tests)
 WINE_CONFIG_MAKEFILE(dlls/msctfp)
 WINE_CONFIG_MAKEFILE(dlls/msdaps)
 WINE_CONFIG_MAKEFILE(dlls/msdasql)
+WINE_CONFIG_MAKEFILE(dlls/msdasql/tests)
 WINE_CONFIG_MAKEFILE(dlls/msdelta)
 WINE_CONFIG_MAKEFILE(dlls/msdmo)
 WINE_CONFIG_MAKEFILE(dlls/msdmo/tests)
diff --git a/dlls/msdasql/tests/Makefile.in b/dlls/msdasql/tests/Makefile.in
new file mode 100644
index 0000000000..4c8717c8e1
--- /dev/null
+++ b/dlls/msdasql/tests/Makefile.in
@@ -0,0 +1,6 @@
+TESTDLL   = msdasql.dll
+IMPORTS   = uuid oleaut32 ole32
+
+C_SRCS = \
+	provider.c
+
diff --git a/dlls/msdasql/tests/provider.c b/dlls/msdasql/tests/provider.c
new file mode 100644
index 0000000000..c3020f2aba
--- /dev/null
+++ b/dlls/msdasql/tests/provider.c
@@ -0,0 +1,82 @@
+/*
+ * Copyright 2019 Alistair Leslie-Hughes
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+
+#include <stdio.h>
+#define COBJMACROS
+
+#include "msdasc.h"
+#include "oledb.h"
+
+#include "initguid.h"
+
+//#include "msdasql_classes.h"
+#include "msdasql.h"
+
+#include "wine/test.h"
+
+/* This needs to be be moved to lib somewhere. */
+DEFINE_GUID(DBPROPSET_DBINITALL, 0xc8b522ca, 0x5cf3, 0x11ce, 0xad, 0xe5, 0x00, 0xaa, 0x00, 0x44, 0x77, 0x3d);
+
+static void test_Properties(void)
+{
+    HRESULT hr;
+    IDBProperties *props;
+    DBPROPIDSET propidset;
+    ULONG infocount;
+    DBPROPINFOSET *propinfoset;
+    WCHAR *desc;
+
+    hr = CoCreateInstance( &CLSID_MSDASQL, NULL, CLSCTX_ALL, &IID_IDBProperties, (void **)&props);
+    ok(hr == S_OK, "Failed to create object 0x%08x\n", hr);
+
+    propidset.rgPropertyIDs = NULL;
+    propidset.cPropertyIDs = 0;
+    propidset.guidPropertySet = DBPROPSET_DBINITALL;
+
+    infocount = 0;
+    hr = IDBProperties_GetPropertyInfo(props, 1, &propidset, &infocount, &propinfoset, &desc);
+    todo_wine ok(hr == S_OK, "got 0x%08x\n", hr);
+    if (hr == S_OK)
+    {
+        ULONG i;
+        trace("desc: %s\n", debugstr_w(desc));
+        trace("Count: %d\n", propinfoset->cPropertyInfos);
+
+        for (i = 0; i < propinfoset->cPropertyInfos; i++)
+        {
+            trace("%d: pwszDescription: %s\n", i, debugstr_w(propinfoset->rgPropertyInfos[i].pwszDescription) );
+        }
+
+        for (i = 0; i < propinfoset->cPropertyInfos; i++)
+            VariantClear(&propinfoset->rgPropertyInfos[i].vValues);
+
+        CoTaskMemFree(propinfoset->rgPropertyInfos);
+        CoTaskMemFree(propinfoset);
+    }
+
+    IDBProperties_Release(props);
+}
+
+START_TEST(provider)
+{
+    CoInitialize(0);
+
+    test_Properties();
+
+    CoUninitialize();
+}
-- 
2.26.2

