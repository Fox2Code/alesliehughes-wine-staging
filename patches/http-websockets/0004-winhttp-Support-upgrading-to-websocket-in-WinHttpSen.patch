From 239317cd01f0b3f7081db5f5c58bd4153445637d Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Mon, 15 Jun 2020 09:45:39 +1000
Subject: [PATCH 4/7] winhttp: Support upgrading to websocket in
 WinHttpSendRequest

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/winhttp/request.c       | 36 ++++++++++++++++++++++++++++++++++++
 dlls/winhttp/tests/winhttp.c | 10 +++++-----
 2 files changed, 41 insertions(+), 5 deletions(-)

diff --git a/dlls/winhttp/request.c b/dlls/winhttp/request.c
index 9173bdb56d1..a018b783069 100644
--- a/dlls/winhttp/request.c
+++ b/dlls/winhttp/request.c
@@ -2217,6 +2217,42 @@ BOOL WINAPI WinHttpSendRequest( HINTERNET hrequest, LPCWSTR headers, DWORD heade
         return FALSE;
     }
 
+    if (request->upgrade_socket)
+    {
+        BYTE buf[16];
+        WCHAR str[64];
+        DWORD length = 64;
+        int i;
+
+        if (add_request_headers(request, L"Connection: Upgrade", -1,
+                                WINHTTP_ADDREQ_FLAG_ADD | WINHTTP_ADDREQ_FLAG_REPLACE))
+            return FALSE;
+        if (add_request_headers(request, L"Upgrade: websocket", -1,
+                                WINHTTP_ADDREQ_FLAG_ADD | WINHTTP_ADDREQ_FLAG_REPLACE))
+            return FALSE;
+        if (add_request_headers(request, L"Sec-WebSocket-Version: 13", -1,
+                                WINHTTP_ADDREQ_FLAG_ADD | WINHTTP_ADDREQ_FLAG_REPLACE))
+            return FALSE;
+
+        srand(time(NULL));
+        for(i = 0; i < sizeof(buf); i++)
+            buf[i] = rand() % 256;
+
+        if (CryptBinaryToStringW(buf, sizeof(buf), CRYPT_STRING_BASE64, str, &length))
+        {
+            WCHAR websocketkey[128];
+
+            /*
+             * As per rfc6455, Sec-WebSocket-Key is a base64-encoded 16 BYTE array value.
+             */
+            swprintf(websocketkey, ARRAY_SIZE(websocketkey), L"Sec-WebSocket-Key: %s", str);
+
+            if (add_request_headers(request, websocketkey, -1,
+                                    WINHTTP_ADDREQ_FLAG_ADD | WINHTTP_ADDREQ_FLAG_REPLACE))
+                return FALSE;
+        }
+    }
+
     if (headers && !headers_len) headers_len = lstrlenW( headers );
 
     if (request->connect->hdr.flags & WINHTTP_FLAG_ASYNC)
diff --git a/dlls/winhttp/tests/winhttp.c b/dlls/winhttp/tests/winhttp.c
index 9f0097a3a1c..292d9e1f46c 100644
--- a/dlls/winhttp/tests/winhttp.c
+++ b/dlls/winhttp/tests/winhttp.c
@@ -3154,22 +3154,22 @@ static void test_websocket_upgrade(int port)
     len = sizeof(buf);
     ret = WinHttpQueryHeaders(req, WINHTTP_QUERY_CUSTOM | WINHTTP_QUERY_FLAG_REQUEST_HEADERS,
                               L"Sec-WebSocket-Key", buf, &len, &index);
-    todo_wine ok(ret, "failed to find header %u\n", GetLastError());
+    ok(ret, "failed to find header %u\n", GetLastError());
 
     ret = WinHttpReceiveResponse(req, NULL);
-    todo_wine ok(ret, "failed to receive response %u\n", GetLastError());
+    ok(ret, "failed to receive response %u\n", GetLastError());
 
     count = 0xdeadbeef;
     ret = WinHttpQueryDataAvailable(req, &count);
     ok(ret, "failed to query data available %u\n", GetLastError());
-    todo_wine ok(!count, "got %u\n", count);
+    ok(!count, "got %u\n", count);
 
     status = 0xdeadbeef;
     size = sizeof(status);
     ret = WinHttpQueryHeaders(req, WINHTTP_QUERY_STATUS_CODE | WINHTTP_QUERY_FLAG_NUMBER,
                               NULL, &status, &size, NULL);
     ok(ret, "failed to get status code %u\n", GetLastError());
-    todo_wine ok(status == HTTP_STATUS_SWITCH_PROTOCOLS, "got %u\n", status);
+    ok(status == HTTP_STATUS_SWITCH_PROTOCOLS, "got %u\n", status);
 
     len = 0xdeadbeef;
     size = sizeof(len);
@@ -3185,7 +3185,7 @@ static void test_websocket_upgrade(int port)
     len = sizeof(buf);
     ret = WinHttpQueryHeaders(req, WINHTTP_QUERY_CUSTOM,
                               L"Sec-WebSocket-Accept", buf, &len, &index);
-    todo_wine ok(ret, "failed to WinHttpQueryHeaders %u\n", GetLastError());
+    ok(ret, "failed to WinHttpQueryHeaders %u\n", GetLastError());
 
     WinHttpCloseHandle(req);
 
-- 
2.27.0

