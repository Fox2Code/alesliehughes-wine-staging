From ef576d1dabf8905efcb155d0418c0c0fdb16cedd Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Mon, 15 Jun 2020 09:16:50 +1000
Subject: [PATCH 3/7] winhttp: Support WINHTTP_OPTION_UPGRADE_TO_WEB_SOCKET
 option

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/winhttp/session.c         | 4 ++++
 dlls/winhttp/tests/winhttp.c   | 2 +-
 dlls/winhttp/winhttp_private.h | 1 +
 3 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/dlls/winhttp/session.c b/dlls/winhttp/session.c
index 24455d858a6..5861f3e3828 100644
--- a/dlls/winhttp/session.c
+++ b/dlls/winhttp/session.c
@@ -1042,6 +1042,10 @@ static BOOL request_set_option( struct object_header *hdr, DWORD option, void *b
         FIXME("WINHTTP_OPTION_CONNECT_RETRIES\n");
         return TRUE;
 
+    case WINHTTP_OPTION_UPGRADE_TO_WEB_SOCKET:
+        request->upgrade_socket = TRUE;
+        return TRUE;
+
     default:
         FIXME("unimplemented option %u\n", option);
         SetLastError( ERROR_WINHTTP_INVALID_OPTION );
diff --git a/dlls/winhttp/tests/winhttp.c b/dlls/winhttp/tests/winhttp.c
index cbcadd7e037..9f0097a3a1c 100644
--- a/dlls/winhttp/tests/winhttp.c
+++ b/dlls/winhttp/tests/winhttp.c
@@ -3137,7 +3137,7 @@ static void test_websocket_upgrade(int port)
     ok(req != NULL, "failed to open a request %u\n", GetLastError());
 
     ret = WinHttpSetOption(req, WINHTTP_OPTION_UPGRADE_TO_WEB_SOCKET, NULL, 0);
-    todo_wine ok(ret, "failed to send request %u\n", GetLastError());
+    ok(ret, "failed to send request %u\n", GetLastError());
 
     index = 0;
     buf[0] = 0;
diff --git a/dlls/winhttp/winhttp_private.h b/dlls/winhttp/winhttp_private.h
index 657f82f6421..1d33ba4c17d 100644
--- a/dlls/winhttp/winhttp_private.h
+++ b/dlls/winhttp/winhttp_private.h
@@ -167,6 +167,7 @@ struct request
     struct netconn *netconn;
     DWORD security_flags;
     BOOL check_revocation;
+    BOOL upgrade_socket;
     const CERT_CONTEXT *server_cert;
     const CERT_CONTEXT *client_cert;
     CredHandle cred_handle;
-- 
2.27.0

