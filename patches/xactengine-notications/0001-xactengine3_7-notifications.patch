From dda991d28a15f925d59e624d16c0b4392404bc6e Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Sat, 12 Sep 2020 14:10:18 +1000
Subject: [PATCH] xactengine3_7: notifications

---
 dlls/xactengine3_7/xact_dll.c | 56 ++++++++++++++++++++++++++++++++---
 1 file changed, 52 insertions(+), 4 deletions(-)

diff --git a/dlls/xactengine3_7/xact_dll.c b/dlls/xactengine3_7/xact_dll.c
index a5ab7e862c1..ec5070255e0 100644
--- a/dlls/xactengine3_7/xact_dll.c
+++ b/dlls/xactengine3_7/xact_dll.c
@@ -261,6 +261,8 @@ static HRESULT WINAPI IXACT3SoundBankImpl_Prepare(IXACT3SoundBank *iface,
     cue->fact_cue = fcue;
     *ppCue = &cue->IXACT3Cue_iface;
 
+    FACTCue_SetPrivateContext(fcue, &cue->IXACT3Cue_iface);
+
     TRACE("Created Cue: %p\n", cue);
 
     return S_OK;
@@ -302,6 +304,8 @@ static HRESULT WINAPI IXACT3SoundBankImpl_Play(IXACT3SoundBank *iface,
         cue->IXACT3Cue_iface.lpVtbl = &XACT3Cue_Vtbl;
         cue->fact_cue = fcue;
         *ppCue = &cue->IXACT3Cue_iface;
+
+        FACTCue_SetPrivateContext(fcue, &cue->IXACT3Cue_iface);
     }
 
     return hr;
@@ -551,6 +555,8 @@ static HRESULT WINAPI IXACT3WaveBankImpl_Prepare(IXACT3WaveBank *iface,
     wave->fact_wave = fwave;
     *ppWave = &wave->IXACT3Wave_iface;
 
+    FACTWave_SetPrivateContext(fwave, &wave->IXACT3Wave_iface);
+
     TRACE("Created Wave: %p\n", wave);
 
     return S_OK;
@@ -592,6 +598,8 @@ static HRESULT WINAPI IXACT3WaveBankImpl_Play(IXACT3WaveBank *iface,
         wave->IXACT3Wave_iface.lpVtbl = &XACT3Wave_Vtbl;
         wave->fact_wave = fwave;
         *ppWave = &wave->IXACT3Wave_iface;
+
+        FACTWave_SetPrivateContext(fwave, &wave->IXACT3Wave_iface);
     }
 
     return hr;
@@ -753,6 +761,7 @@ static HRESULT WINAPI IXACT3EngineImpl_GetFinalMixFormat(IXACT3Engine *iface,
 static void FACTCALL fact_notification_cb(const FACTNotification *notification)
 {
     XACT3EngineImpl *engine = (XACT3EngineImpl *)notification->pvContext;
+    XACT_NOTIFICATION note;
 
     /* Older versions of FAudio don't pass through the context */
     if (!engine)
@@ -761,12 +770,39 @@ static void FACTCALL fact_notification_cb(const FACTNotification *notification)
         return;
     }
 
-    if (notification->type == XACTNOTIFICATIONTYPE_SOUNDBANKDESTROYED)
+    note.type = notification->type;
+    note.pvContext = engine->contexts[notification->type - 1];
+
+    switch (notification->type)
     {
-        FIXME("Callback XACTNOTIFICATIONTYPE_SOUNDBANKDESTROYED\n");
+        case XACTNOTIFICATIONTYPE_SOUNDBANKDESTROYED:
+            note.u.soundBank.pSoundBank = FACTSoundBank_GetPrivateContext(notification->wave.pSoundBank);
+            break;
+        case XACTNOTIFICATIONTYPE_WAVEDESTROYED:
+        case XACTNOTIFICATIONTYPE_WAVELOOPED:
+        case XACTNOTIFICATIONTYPE_WAVEPLAY:
+        case XACTNOTIFICATIONTYPE_WAVEPREPARED:
+        case XACTNOTIFICATIONTYPE_WAVESTOP:
+            note.u.wave.cueIndex = notification->wave.cueIndex;
+            note.u.wave.pCue = FACTCue_GetPrivateContext(notification->wave.pCue);
+            note.u.wave.pSoundBank = FACTSoundBank_GetPrivateContext(notification->wave.pSoundBank);
+            note.u.wave.pWave = FACTWave_GetPrivateContext(notification->wave.pWave);
+            note.u.wave.pWaveBank = FACTWaveBank_GetPrivateContext(notification->wave.pWaveBank);
+            break;
+        case XACTNOTIFICATIONTYPE_CUEDESTROYED:
+        case XACTNOTIFICATIONTYPE_CUEPLAY:
+        case XACTNOTIFICATIONTYPE_CUEPREPARED:
+        case XACTNOTIFICATIONTYPE_CUESTOP:
+            note.u.cue.cueIndex = notification->cue.cueIndex;
+            note.u.cue.pCue = FACTCue_GetPrivateContext(notification->cue.pCue);
+            note.u.cue.pSoundBank = FACTSoundBank_GetPrivateContext(notification->cue.pSoundBank);
+            break;
+        default:
+            FIXME("Unsupported callback type %d\n", notification->type);
+            return;
     }
-    else
-        FIXME("Unsupported callback type %d\n", notification->type);
+
+    engine->notification_callback(&note);
 }
 
 static HRESULT WINAPI IXACT3EngineImpl_Initialize(IXACT3Engine *iface,
@@ -880,6 +916,8 @@ static HRESULT WINAPI IXACT3EngineImpl_CreateSoundBank(IXACT3Engine *iface,
     sb->fact_soundbank = fsb;
     *ppSoundBank = &sb->IXACT3SoundBank_iface;
 
+    FACTSoundBank_SetPrivateContext(fsb, &sb->IXACT3SoundBank_iface);
+
     TRACE("Created SoundBank: %p\n", sb);
 
     return S_OK;
@@ -956,6 +994,8 @@ static HRESULT WINAPI IXACT3EngineImpl_CreateInMemoryWaveBank(IXACT3Engine *ifac
 
     send_wavebank_notification(This, &wb->IXACT3WaveBank_iface);
 
+    FACTWaveBank_SetPrivateContext(fwb, &wb->IXACT3WaveBank_iface);
+
     TRACE("Created in-memory WaveBank: %p\n", wb);
 
     return S_OK;
@@ -1006,6 +1046,8 @@ static HRESULT WINAPI IXACT3EngineImpl_CreateStreamingWaveBank(IXACT3Engine *ifa
 
     send_wavebank_notification(This, &wb->IXACT3WaveBank_iface);
 
+    FACTWaveBank_SetPrivateContext(fwb, &wb->IXACT3WaveBank_iface);
+
     TRACE("Created streaming WaveBank: %p\n", wb);
 
     return S_OK;
@@ -1052,6 +1094,8 @@ static HRESULT WINAPI IXACT3EngineImpl_PrepareInMemoryWave(IXACT3Engine *iface,
     wave->fact_wave = fwave;
     *ppWave = &wave->IXACT3Wave_iface;
 
+    FACTWave_SetPrivateContext(fwave, &wave->IXACT3Wave_iface);
+
     TRACE("Created Wave: %p\n", wave);
 
     return S_OK;
@@ -1114,6 +1158,8 @@ static HRESULT WINAPI IXACT3EngineImpl_PrepareStreamingWave(IXACT3Engine *iface,
     wave->fact_wave = fwave;
     *ppWave = &wave->IXACT3Wave_iface;
 
+    FACTWave_SetPrivateContext(fwave, &wave->IXACT3Wave_iface);
+
     TRACE("Created Wave: %p\n", wave);
 
     return S_OK;
@@ -1152,6 +1198,8 @@ static HRESULT WINAPI IXACT3EngineImpl_PrepareWave(IXACT3Engine *iface,
     wave->fact_wave = fwave;
     *ppWave = &wave->IXACT3Wave_iface;
 
+    FACTWave_SetPrivateContext(fwave, &wave->IXACT3Wave_iface);
+
     TRACE("Created Wave: %p\n", wave);
 
     return S_OK;
-- 
2.30.0

