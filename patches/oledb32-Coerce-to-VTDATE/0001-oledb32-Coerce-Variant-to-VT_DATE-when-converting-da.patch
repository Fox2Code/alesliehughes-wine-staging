From c38c59d7705d338f1e241eb0e0168b7f438a2623 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Fri, 22 Dec 2017 11:19:36 +1100
Subject: [PATCH] oledb32: Coerce Variant to VT_DATE when converting data

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/oledb32/convert.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/dlls/oledb32/convert.c b/dlls/oledb32/convert.c
index 267de1b..3634ef4 100644
--- a/dlls/oledb32/convert.c
+++ b/dlls/oledb32/convert.c
@@ -475,10 +475,13 @@ static HRESULT WINAPI convert_DataConvert(IDataConvert* iface,
         }
         break;
         case DBTYPE_VARIANT:
-            if( V_VT((VARIANT*)src) == VT_DATE)
+        {
+            VariantInit(&tmp);
+
+            if ((hr = VariantChangeType((VARIANT*)src, &tmp, 0, VT_DATE)) == S_OK)
             {
                 SYSTEMTIME st;
-                hr = (VariantTimeToSystemTime( V_DATE((VARIANT*)src), &st) ? S_OK : E_FAIL);
+                hr = (VariantTimeToSystemTime( V_DATE(&tmp), &st) ? S_OK : E_FAIL);
                 d->year = st.wYear;
                 d->month = st.wMonth;
                 d->day = st.wDay;
@@ -489,6 +492,7 @@ static HRESULT WINAPI convert_DataConvert(IDataConvert* iface,
                 return E_NOTIMPL;
             }
             break;
+        }
         default: FIXME("Unimplemented conversion %04x -> DBDATE\n", src_type); return  E_NOTIMPL;
         }
         break;
-- 
1.9.1

