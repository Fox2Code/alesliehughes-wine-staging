From 40b169ab3c062f934988b466b3c690fa476b00ec Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Mon, 22 Oct 2018 14:46:41 +1100
Subject: [PATCH 3/4] odbc32: Support SQL_ATTR_CONNECTION_POOLING in
 SQLGetEnvAttr/SQLSetEnvAttr

---
 dlls/odbc32/odbc_main.c | 46 ++++++++++++++++++++++++++++++++++++++--------
 1 file changed, 38 insertions(+), 8 deletions(-)

diff --git a/dlls/odbc32/odbc_main.c b/dlls/odbc32/odbc_main.c
index 353e379..aec2209 100644
--- a/dlls/odbc32/odbc_main.c
+++ b/dlls/odbc32/odbc_main.c
@@ -107,7 +107,6 @@ static SQLRETURN (*pSQLGetDiagField)(SQLSMALLINT,SQLHANDLE,SQLSMALLINT,SQLSMALLI
 static SQLRETURN (*pSQLGetDiagFieldW)(SQLSMALLINT,SQLHANDLE,SQLSMALLINT,SQLSMALLINT,SQLPOINTER,SQLSMALLINT,SQLSMALLINT*);
 static SQLRETURN (*pSQLGetDiagRec)(SQLSMALLINT,SQLHANDLE,SQLSMALLINT,SQLCHAR*,SQLINTEGER*,SQLCHAR*,SQLSMALLINT,SQLSMALLINT*);
 static SQLRETURN (*pSQLGetDiagRecW)(SQLSMALLINT,SQLHANDLE,SQLSMALLINT,SQLWCHAR*,SQLINTEGER*,SQLWCHAR*,SQLSMALLINT,SQLSMALLINT*);
-static SQLRETURN (*pSQLGetEnvAttr)(SQLHENV,SQLINTEGER,SQLPOINTER,SQLINTEGER,SQLINTEGER*);
 static SQLRETURN (*pSQLGetFunctions)(SQLHDBC,SQLUSMALLINT,SQLUSMALLINT*);
 static SQLRETURN (*pSQLGetInfo)(SQLHDBC,SQLUSMALLINT,SQLPOINTER,SQLSMALLINT,SQLSMALLINT*);
 static SQLRETURN (*pSQLGetInfoW)(SQLHDBC,SQLUSMALLINT,SQLPOINTER,SQLSMALLINT,SQLSMALLINT*);
@@ -142,7 +141,6 @@ static SQLRETURN (*pSQLSetCursorNameW)(SQLHSTMT,SQLWCHAR*,SQLSMALLINT);
 static SQLRETURN (*pSQLSetDescField)(SQLHDESC,SQLSMALLINT,SQLSMALLINT,SQLPOINTER,SQLINTEGER);
 static SQLRETURN (*pSQLSetDescFieldW)(SQLHDESC,SQLSMALLINT,SQLSMALLINT,SQLPOINTER,SQLINTEGER);
 static SQLRETURN (*pSQLSetDescRec)(SQLHDESC,SQLSMALLINT,SQLSMALLINT,SQLSMALLINT,SQLLEN,SQLSMALLINT,SQLSMALLINT,SQLPOINTER,SQLLEN*,SQLLEN*);
-static SQLRETURN (*pSQLSetEnvAttr)(SQLHENV,SQLINTEGER,SQLPOINTER,SQLINTEGER);
 static SQLRETURN (*pSQLSetParam)(SQLHSTMT,SQLUSMALLINT,SQLSMALLINT,SQLSMALLINT,SQLULEN,SQLSMALLINT,SQLPOINTER,SQLLEN*);
 static SQLRETURN (*pSQLSetPos)(SQLHSTMT,SQLSETPOSIROW,SQLUSMALLINT,SQLUSMALLINT);
 static SQLRETURN (*pSQLSetScrollOptions)(SQLHSTMT,SQLUSMALLINT,SQLLEN,SQLUSMALLINT);
@@ -177,6 +175,7 @@ SQLRETURN WINAPI ODBC32_SQLDrivers(SQLHENV, SQLUSMALLINT, SQLCHAR *, SQLSMALLINT
 struct SQLHENV_data
 {
     int type;
+    SQLINTEGER pooling;
 };
 
 /***********************************************************************
@@ -284,7 +283,6 @@ static BOOL ODBC_LoadDMFunctions(void)
     LOAD_FUNC(SQLGetDiagRec);
     LOAD_FUNC(SQLGetDiagRecA);
     LOAD_FUNC(SQLGetDiagRecW);
-    LOAD_FUNC(SQLGetEnvAttr);
     LOAD_FUNC(SQLGetFunctions);
     LOAD_FUNC(SQLGetInfo);
     LOAD_FUNC(SQLGetInfoW);
@@ -319,7 +317,6 @@ static BOOL ODBC_LoadDMFunctions(void)
     LOAD_FUNC(SQLSetDescField);
     LOAD_FUNC(SQLSetDescFieldW);
     LOAD_FUNC(SQLSetDescRec);
-    LOAD_FUNC(SQLSetEnvAttr);
     LOAD_FUNC(SQLSetParam);
     LOAD_FUNC(SQLSetPos);
     LOAD_FUNC(SQLSetScrollOptions);
@@ -380,6 +377,8 @@ SQLRETURN WINAPI ODBC32_SQLAllocEnv(SQLHENV *EnvironmentHandle)
     if (!data)
        return SQL_ERROR;
 
+    data->pooling = 0;
+
     *EnvironmentHandle = data;
 
     return SQL_SUCCESS;
@@ -980,11 +979,29 @@ SQLRETURN WINAPI ODBC32_SQLGetEnvAttr(SQLHENV EnvironmentHandle,
              SQLINTEGER Attribute, SQLPOINTER Value,
              SQLINTEGER BufferLength, SQLINTEGER *StringLength)
 {
+    struct SQLHENV_data *data = EnvironmentHandle;
     FIXME("EnvironmentHandle %p, Attribute %d, Value %p, BufferLength %d, StringLength %p\n",
         EnvironmentHandle, Attribute, Value, BufferLength, StringLength);
 
-    if (!pSQLGetEnvAttr) return SQL_ERROR;
-    return pSQLGetEnvAttr(EnvironmentHandle, Attribute, Value, BufferLength, StringLength);
+    if(!EnvironmentHandle)
+        return SQL_ERROR;
+
+    switch(Attribute)
+    {
+        case SQL_ATTR_CONNECTION_POOLING:
+            if(BufferLength != sizeof(data->pooling) )
+            {
+                WARN("Invalid buffer size\n");
+                return SQL_ERROR;
+            }
+            memcpy( Value, &data->pooling, sizeof(data->pooling));
+            break;
+        default:
+            FIXME("Unhandle attribute %d\n", Attribute);
+            return SQL_ERROR;
+    }
+
+	return SQL_SUCCESS;
 }
 
 
@@ -1189,11 +1206,24 @@ SQLRETURN WINAPI ODBC32_SQLSetEnvAttr(SQLHENV EnvironmentHandle,
              SQLINTEGER Attribute, SQLPOINTER Value,
              SQLINTEGER StringLength)
 {
+    struct SQLHENV_data *data = EnvironmentHandle;
     FIXME("EnvironmentHandle %p, Attribute %d, Value %p, StringLength %d\n",
         EnvironmentHandle, Attribute, Value, StringLength);
 
-	if (!pSQLSetEnvAttr) return SQL_ERROR;
-	return pSQLSetEnvAttr(EnvironmentHandle, Attribute, Value, StringLength);
+    if(!EnvironmentHandle)
+        return SQL_ERROR;
+
+    switch(Attribute)
+    {
+        case SQL_ATTR_CONNECTION_POOLING:
+            data->pooling = *(SQLINTEGER*)Value;
+            break;
+        default:
+            FIXME("Unhandle attribute %d\n", Attribute);
+            return SQL_ERROR;
+    }
+
+	return SQL_SUCCESS;
 }
 
 
-- 
1.9.1

