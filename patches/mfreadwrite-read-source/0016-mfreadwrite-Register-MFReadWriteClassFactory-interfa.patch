From 5773e027aa73df4247c8c59957e19b08e36846fd Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Fri, 4 Jan 2019 09:41:27 +1100
Subject: [PATCH] mfreadwrite: Register MFReadWriteClassFactory interface

---
 dlls/mfreadwrite/Makefile.in      |  2 ++
 dlls/mfreadwrite/main.c           | 16 +++++++++++++++-
 dlls/mfreadwrite/mf_classes.idl   | 25 +++++++++++++++++++++++++
 dlls/mfreadwrite/mfreadwrite.spec |  2 ++
 4 files changed, 44 insertions(+), 1 deletion(-)
 create mode 100644 dlls/mfreadwrite/mf_classes.idl

diff --git a/dlls/mfreadwrite/Makefile.in b/dlls/mfreadwrite/Makefile.in
index 3d2ce74..3dc18de 100644
--- a/dlls/mfreadwrite/Makefile.in
+++ b/dlls/mfreadwrite/Makefile.in
@@ -4,3 +4,5 @@ IMPORTLIB = mfreadwrite
 
 C_SRCS = \
 	main.c
+
+IDL_SRCS = mf_classes.idl
diff --git a/dlls/mfreadwrite/main.c b/dlls/mfreadwrite/main.c
index c526ac6..ae725f8 100644
--- a/dlls/mfreadwrite/main.c
+++ b/dlls/mfreadwrite/main.c
@@ -27,19 +27,23 @@
 #include "initguid.h"
 #include "mfapi.h"
 #include "mfreadwrite.h"
+#include "rpcproxy.h"
 
 #include "wine/heap.h"
 #include "wine/debug.h"
 
 WINE_DEFAULT_DEBUG_CHANNEL(mfplat);
 
-BOOL WINAPI DllMain(HINSTANCE instance, DWORD reason, LPVOID reserved)
+static HINSTANCE instance;
+
+BOOL WINAPI DllMain(HINSTANCE hInstDLL, DWORD reason, LPVOID reserved)
 {
     switch (reason)
     {
         case DLL_WINE_PREATTACH:
             return FALSE;    /* prefer native version */
         case DLL_PROCESS_ATTACH:
+            instance = hInstDLL;
             DisableThreadLibraryCalls(instance);
             break;
     }
@@ -58,6 +62,16 @@ HRESULT WINAPI DllCanUnloadNow(void)
     return S_FALSE;
 }
 
+HRESULT WINAPI DllRegisterServer(void)
+{
+    return __wine_register_resources( instance );
+}
+
+HRESULT WINAPI DllUnregisterServer(void)
+{
+    return __wine_unregister_resources( instance );
+}
+
 typedef struct _srcreader
 {
     IMFSourceReader IMFSourceReader_iface;
diff --git a/dlls/mfreadwrite/mf_classes.idl b/dlls/mfreadwrite/mf_classes.idl
new file mode 100644
index 0000000..99dbd80
--- /dev/null
+++ b/dlls/mfreadwrite/mf_classes.idl
@@ -0,0 +1,25 @@
+/*
+ *
+ * Copyright 2019 Alistair Leslie-Hughes
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+#pragma makedep register
+
+[
+    threading(both),
+    uuid(48e2ed0f-98c2-4a37-bed5-166312ddd83f)
+]
+coclass MFReadWriteClassFactory { interface IMFReadWriteClassFactory; }
diff --git a/dlls/mfreadwrite/mfreadwrite.spec b/dlls/mfreadwrite/mfreadwrite.spec
index 22e8337..05049f5 100644
--- a/dlls/mfreadwrite/mfreadwrite.spec
+++ b/dlls/mfreadwrite/mfreadwrite.spec
@@ -1,5 +1,7 @@
 @ stdcall -private DllCanUnloadNow()
 @ stdcall -private DllGetClassObject(ptr ptr ptr)
+@ stdcall -private DllRegisterServer()
+@ stdcall -private DllUnregisterServer()
 @ stub MFCreateSinkWriterFromMediaSink
 @ stdcall MFCreateSinkWriterFromURL(wstr ptr ptr ptr)
 @ stdcall MFCreateSourceReaderFromByteStream(ptr ptr ptr)
-- 
1.9.1

