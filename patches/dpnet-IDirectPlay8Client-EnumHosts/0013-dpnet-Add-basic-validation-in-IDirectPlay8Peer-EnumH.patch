From 62896682d598b2392eea733375254e38c4a436a9 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Fri, 18 Nov 2016 09:01:22 +1100
Subject: [PATCH 13/19] dpnet: Add basic validation in IDirectPlay8Peer
 EnumHosts

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/dpnet/peer.c       | 11 +++++++++++
 dlls/dpnet/tests/peer.c |  8 ++++----
 2 files changed, 15 insertions(+), 4 deletions(-)

diff --git a/dlls/dpnet/peer.c b/dlls/dpnet/peer.c
index b12cfb9..f160768 100644
--- a/dlls/dpnet/peer.c
+++ b/dlls/dpnet/peer.c
@@ -446,10 +446,21 @@ static HRESULT WINAPI IDirectPlay8PeerImpl_EnumHosts(IDirectPlay8Peer *iface,
         const DWORD dwUserEnumDataSize, const DWORD dwEnumCount, const DWORD dwRetryInterval,
         const DWORD dwTimeOut, void * const pvUserContext, DPNHANDLE * const pAsyncHandle, const DWORD dwFlags)
 {
+    IDirectPlay8PeerImpl* This = impl_from_IDirectPlay8Peer(iface);
+
     FIXME("(%p)->(%p,%p,%p,%p,%x,%x,%x,%x,%p,%p,%x): stub\n",
             iface, pApplicationDesc, pAddrHost, pDeviceInfo, pUserEnumData, dwUserEnumDataSize, dwEnumCount,
             dwRetryInterval, dwTimeOut, pvUserContext, pAsyncHandle, dwFlags);
 
+    if(!This->msghandler)
+        return DPNERR_UNINITIALIZED;
+
+    if((dwFlags & DPNENUMHOSTS_SYNC) && pAsyncHandle)
+        return DPNERR_INVALIDPARAM;
+
+    if(dwUserEnumDataSize > This->spcaps.dwMaxEnumPayloadSize)
+        return DPNERR_ENUMQUERYTOOLARGE;
+
     return DPNERR_GENERIC;
 }
 
diff --git a/dlls/dpnet/tests/peer.c b/dlls/dpnet/tests/peer.c
index 14b423f..5c2daa5 100644
--- a/dlls/dpnet/tests/peer.c
+++ b/dlls/dpnet/tests/peer.c
@@ -200,16 +200,16 @@ static void test_enum_hosts(void)
     data = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, caps.dwMaxEnumPayloadSize + 1);
 
     hr = IDirectPlay8Peer_EnumHosts(peer, &appdesc, host, local, NULL, 0, 2, 1000, 1000, NULL,  &async, DPNENUMHOSTS_SYNC);
-    todo_wine ok(hr == DPNERR_INVALIDPARAM, "got 0x%08x\n", hr);
+    ok(hr == DPNERR_INVALIDPARAM, "got 0x%08x\n", hr);
 
     hr = IDirectPlay8Peer_EnumHosts(peer, &appdesc, host, local, data, caps.dwMaxEnumPayloadSize + 1,
                                         INFINITE, 0, INFINITE, NULL,  &async, DPNENUMHOSTS_SYNC);
-    todo_wine ok(hr == DPNERR_INVALIDPARAM, "got 0x%08x\n", hr);
+    ok(hr == DPNERR_INVALIDPARAM, "got 0x%08x\n", hr);
 
     async = 0;
     hr = IDirectPlay8Peer_EnumHosts(peer, &appdesc, host, local, data, caps.dwMaxEnumPayloadSize + 1, INFINITE, 0,
                                         INFINITE, NULL,  &async, 0);
-    todo_wine ok(hr == DPNERR_ENUMQUERYTOOLARGE, "got 0x%08x\n", hr);
+    ok(hr == DPNERR_ENUMQUERYTOOLARGE, "got 0x%08x\n", hr);
     ok(!async, "Handle returned\n");
 
     async = 0;
@@ -225,7 +225,7 @@ static void test_enum_hosts(void)
 
     /* No Initialize has been called on peer2. */
     hr = IDirectPlay8Peer_EnumHosts(peer2, &appdesc, host, local, NULL, 0, INFINITE, 0, INFINITE, NULL,  &async, 0);
-    todo_wine ok(hr == DPNERR_UNINITIALIZED, "got 0x%08x\n", hr);
+    ok(hr == DPNERR_UNINITIALIZED, "got 0x%08x\n", hr);
 
     /* Since we are running asynchronously, EnumHosts returns DPNSUCCESS_PENDING. */
     async = 0;
-- 
1.9.1

