From ca9002e45851fde540f49ad9e41aa65f369b617f Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Fri, 24 Feb 2017 12:02:46 +1100
Subject: [PATCH 42/42] dpnet: Handle invalid service GUID in
 enum_services_providers

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/dpnet/peer.c         |  4 ++--
 dlls/dpnet/tests/client.c | 12 ++++++++++++
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/dlls/dpnet/peer.c b/dlls/dpnet/peer.c
index c8a20a6..45e1670 100644
--- a/dlls/dpnet/peer.c
+++ b/dlls/dpnet/peer.c
@@ -164,10 +164,10 @@ HRESULT enum_services_providers(const GUID * const service, DPN_SERVICE_PROVIDER
     if(!returned || !buf_size)
         return E_POINTER;
 
-    *returned = 0;
-
     if(!service)
     {
+        *returned = 0;
+
         res = RegOpenKeyExW(HKEY_LOCAL_MACHINE, serviceproviders, 0, KEY_READ, &key);
         if(res == ERROR_FILE_NOT_FOUND)
             return DPNERR_DOESNOTEXIST;
diff --git a/dlls/dpnet/tests/client.c b/dlls/dpnet/tests/client.c
index ed37ca4..aa52465 100644
--- a/dlls/dpnet/tests/client.c
+++ b/dlls/dpnet/tests/client.c
@@ -211,6 +211,12 @@ static void test_enum_service_providers(void)
     }
 
     ok(HeapFree(GetProcessHeap(), 0, serv_prov_info), "Failed freeing server provider info\n");
+
+    /* Invalid GUID */
+    items = 88;
+    hr = IDirectPlay8Client_EnumServiceProviders(client, &appguid, NULL, serv_prov_info, &size, &items, 0);
+    ok(hr == DPNERR_DOESNOTEXIST, "IDirectPlay8Peer_EnumServiceProviders failed with %x\n", hr);
+    ok(items == 88, "Found adapter %d\n", items);
 }
 
 static void test_enum_hosts(void)
@@ -573,6 +579,12 @@ static void test_enum_service_providers_peer(void)
 
     serv_prov_info -= items; /* set pointer back */
     ok(HeapFree(GetProcessHeap(), 0, serv_prov_info), "Failed freeing server provider info\n");
+
+    /* Invalid GUID */
+    items = 88;
+    hr = IDirectPlay8Peer_EnumServiceProviders(peer, &appguid, NULL, serv_prov_info, &size, &items, 0);
+    ok(hr == DPNERR_DOESNOTEXIST, "IDirectPlay8Peer_EnumServiceProviders failed with %x\n", hr);
+    ok(items == 88, "Found adapter %d\n", items);
 }
 
 static void test_enum_hosts_peer(void)
-- 
1.9.1

