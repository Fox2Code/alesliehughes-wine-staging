From 7f43c1c059ad8fd453251d6ab4b6d0d83677e80e Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Wed, 24 Oct 2018 14:34:39 +1100
Subject: [PATCH] oledb32: Implement IDataSourceLocator PromptNew

TODO: Add OLE DB Provider to Keys (if possible).
0009:fixme:oledb:add_connectons_providers Found L"{0C7FF16C-38E3-11d0-97AB-00C04FC2AD98}\\OLE DB Provider"
0009:fixme:oledb:add_connectons_providers Found L"{3449A1C8-C56C-11D0-AD72-00C04FC29863}\\OLE DB Provider"
0009:fixme:oledb:add_connectons_providers Found L"{c8b522cb-5cf3-11ce-ade5-00aa0044773d}\\OLE DB Provider"
0009:fixme:oledb:add_connectons_providers Found L"{dfc8bdc0-e378-11d0-9b30-0080c7e9fe95}\\OLE DB Provider"
0009:fixme:oledb:add_connectons_providers Found L"{e8cc4cbe-fdff-11d0-b865-00a0c9081c1d}\\OLE DB Provider"
---
 dlls/oledb32/Makefile.in      |   1 +
 dlls/oledb32/dslocator.c      | 144 +++++++++++++++++++++++++++++++++++++++++-
 dlls/oledb32/main.c           |   2 +-
 dlls/oledb32/oledb_private.h  |   2 +
 dlls/oledb32/resource.h       |  25 ++++++++
 dlls/oledb32/tests/database.c |  13 ++--
 dlls/oledb32/version.rc       |  21 ++++++
 7 files changed, 201 insertions(+), 7 deletions(-)
 create mode 100644 dlls/oledb32/resource.h

diff --git a/dlls/oledb32/Makefile.in b/dlls/oledb32/Makefile.in
index a32e9b1..89c0a48 100644
--- a/dlls/oledb32/Makefile.in
+++ b/dlls/oledb32/Makefile.in
@@ -1,5 +1,6 @@
 MODULE    = oledb32.dll
 IMPORTS   = uuid oleaut32 ole32 user32 advapi32
+DELAYIMPORTS = comctl32
 
 C_SRCS = \
 	convert.c \
diff --git a/dlls/oledb32/dslocator.c b/dlls/oledb32/dslocator.c
index d397e47..20273de 100644
--- a/dlls/oledb32/dslocator.c
+++ b/dlls/oledb32/dslocator.c
@@ -20,6 +20,7 @@
 #include <string.h>
 
 #define COBJMACROS
+#define NONAMELESSUNION
 
 #include "windef.h"
 #include "winbase.h"
@@ -29,8 +30,11 @@
 #include "oledb.h"
 #include "oledberr.h"
 #include "msdasc.h"
+#include "prsht.h"
+#include "commctrl.h"
 
 #include "oledb_private.h"
+#include "resource.h"
 
 #include "wine/debug.h"
 #include "wine/heap.h"
@@ -188,11 +192,147 @@ static HRESULT WINAPI dslocator_put_hWnd(IDataSourceLocator *iface, COMPATIBLE_L
     return S_OK;
 }
 
+static void create_connections_columns(HWND lv)
+{
+    RECT rc;
+    WCHAR buf[256];
+    LVCOLUMNW column;
+
+    SendMessageW(lv, LVM_SETEXTENDEDLISTVIEWSTYLE, 0, LVS_EX_FULLROWSELECT);
+    GetWindowRect(lv, &rc);
+    LoadStringW(instance, IDS_COL_PROVIDER, buf, ARRAY_SIZE(buf));
+    column.mask = LVCF_WIDTH | LVCF_TEXT;
+    column.cx = (rc.right - rc.left) - 5;
+    column.pszText = buf;
+    SendMessageW(lv, LVM_INSERTCOLUMNW, 0, (LPARAM)&column);
+}
+
+static void add_connectons_providers(HWND lv)
+{
+    static const WCHAR clsidkey[] = {'C','L','S','I','D',0};
+    static const WCHAR oledbprov[] = {'\\','O','L','E',' ','D','B',' ','P','r','o','v','i','d','e','r',0};
+    LONG res;
+    HKEY key = NULL, subkey;
+    DWORD index = 0;
+    LONG next_key;
+    WCHAR provider[MAX_PATH];
+    WCHAR guidkey[MAX_PATH];
+    LONG size;
+
+    res = RegOpenKeyExW(HKEY_CLASSES_ROOT, clsidkey, 0, KEY_READ, &key);
+    if (res == ERROR_FILE_NOT_FOUND)
+        return;
+
+    next_key = RegEnumKeyW(key, index, provider, MAX_PATH);
+    while (next_key == ERROR_SUCCESS)
+    {
+        WCHAR description[MAX_PATH];
+
+        lstrcpyW(guidkey, provider);
+        lstrcatW(guidkey, oledbprov);
+
+        res = RegOpenKeyW(key, guidkey, &subkey);
+        if (res == ERROR_SUCCESS)
+        {
+            TRACE("Found %s\n", debugstr_w(guidkey));
+
+            size = MAX_PATH;
+            res = RegQueryValueW(subkey, NULL, description, &size);
+            if (res == ERROR_SUCCESS)
+            {
+                LVITEMW item;
+                item.mask = LVIF_TEXT;
+                item.iItem = SendMessageW(lv, LVM_GETITEMCOUNT, 0, 0);
+                item.iSubItem = 0;
+                item.pszText = description;
+                SendMessageW(lv, LVM_INSERTITEMW, 0, (LPARAM)&item);
+                /* TODO - Add ProgID to item data */
+            }
+            RegCloseKey(subkey);
+        }
+
+        index++;
+        next_key = RegEnumKeyW(key, index, provider, MAX_PATH);
+    }
+
+    RegCloseKey(key);
+}
+
+static LRESULT CALLBACK data_link_properties_dlg_proc(HWND hwnd, UINT msg,
+ WPARAM wp, LPARAM lp)
+{
+    //PROPSHEETPAGEW *page;
+
+    TRACE("(%p, %08x, %08lx, %08lx)\n", hwnd, msg, wp, lp);
+
+    switch (msg)
+    {
+    case WM_INITDIALOG:
+    {
+        HWND lv = GetDlgItem(hwnd, IDC_LST_CONNECTIONS);
+        create_connections_columns(lv);
+        add_connectons_providers(lv);
+        
+        break;
+    }
+    case WM_NOTIFY:
+    {
+        NMHDR *hdr = (NMHDR *)lp;
+        //NMITEMACTIVATE *nm;
+
+        switch (hdr->code)
+        {
+        case NM_CLICK:
+            //nm = (NMITEMACTIVATE *)lp;
+            //toggle_usage(hwnd, nm->iItem);
+            //SendMessageW(GetParent(hwnd), PSM_CHANGED, (WPARAM)hwnd, 0);
+            break;
+        case PSN_APPLY:
+            //apply_general_changes(hwnd);
+            break;
+        }
+        break;
+    }
+    case WM_COMMAND:
+        switch (HIWORD(wp))
+        {
+            case EN_CHANGE:
+                break;
+            case BN_CLICKED:
+                break;
+        }
+        break;
+    }
+    return 0;
+}
+
+#define MAX_PROP_PAGES 5
+
 static HRESULT WINAPI dslocator_PromptNew(IDataSourceLocator *iface, IDispatch **ppADOConnection)
 {
     DSLocatorImpl *This = impl_from_IDataSourceLocator(iface);
-
-    FIXME("(%p)->(%p)\n",This, ppADOConnection);
+    PROPSHEETHEADERW hdr;
+    PROPSHEETPAGEW page;
+
+    FIXME("(%p, %p)\n", iface, ppADOConnection);
+
+    memset(&page, 0, sizeof(PROPSHEETPAGEW));
+    page.dwSize = sizeof(page);
+    //page.dwFlags = PSP_USECALLBACK;
+    //page.pfnCallback = cert_properties_general_callback;
+    page.hInstance = instance;
+    page.u.pszTemplate = MAKEINTRESOURCEW(IDD_PROVIDER);
+    page.pfnDlgProc = data_link_properties_dlg_proc;
+
+    memset(&hdr, 0, sizeof(hdr));
+    hdr.dwSize = sizeof(hdr);
+    hdr.hwndParent = This->hwnd;
+    hdr.dwFlags = PSH_NOAPPLYNOW | PSH_PROPSHEETPAGE;
+    hdr.hInstance = instance;
+    hdr.pszCaption = MAKEINTRESOURCEW(IDS_PROPSHEET_TITLE);
+    hdr.u3.ppsp = &page;
+    hdr.nPages = 1;
+    PropertySheetW(&hdr);
 
     return E_NOTIMPL;
 }
diff --git a/dlls/oledb32/main.c b/dlls/oledb32/main.c
index f28e57a..9c8c7f2 100644
--- a/dlls/oledb32/main.c
+++ b/dlls/oledb32/main.c
@@ -36,7 +36,7 @@
 
 WINE_DEFAULT_DEBUG_CHANNEL(oledb);
 
-static HINSTANCE instance;
+HINSTANCE instance;
 
 DEFINE_GUID(CSLID_MSDAER, 0xc8b522cf,0x5cf3,0x11ce,0xad,0xe5,0x00,0xaa,0x00,0x44,0x77,0x3d);
 
diff --git a/dlls/oledb32/oledb_private.h b/dlls/oledb32/oledb_private.h
index 4e285b5..fee0318 100644
--- a/dlls/oledb32/oledb_private.h
+++ b/dlls/oledb32/oledb_private.h
@@ -26,6 +26,8 @@ HRESULT create_dslocator(IUnknown *outer, void **obj) DECLSPEC_HIDDEN;
 HRESULT get_data_source(IUnknown *outer, DWORD clsctx, LPWSTR initstring, REFIID riid,
     IUnknown **datasource) DECLSPEC_HIDDEN;
 
+extern HINSTANCE instance;
+
 static inline void* __WINE_ALLOC_SIZE(2) heap_realloc_zero(void *mem, size_t size)
 {
     return HeapReAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, mem, size);
diff --git a/dlls/oledb32/resource.h b/dlls/oledb32/resource.h
new file mode 100644
index 0000000..5dc5704
--- /dev/null
+++ b/dlls/oledb32/resource.h
@@ -0,0 +1,25 @@
+/*
+ * Copyright 2018 Alistair Leslie-Hughes
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+
+#define IDD_PROVIDER        1000
+#define IDC_BTN_NEXT        1001
+#define IDC_LST_CONNECTIONS 1002
+
+
+#define IDS_PROPSHEET_TITLE 2000
+#define IDS_COL_PROVIDER    2001
diff --git a/dlls/oledb32/tests/database.c b/dlls/oledb32/tests/database.c
index 8ff55b9..94a17d4 100644
--- a/dlls/oledb32/tests/database.c
+++ b/dlls/oledb32/tests/database.c
@@ -939,6 +939,11 @@ static void test_dslocator(void)
 
         hr = IDataSourceLocator_QueryInterface(dslocator, &IID_IRpcOptions, (void **)&opts);
         ok(hr == E_NOINTERFACE, "got %08x\n", hr);
+        
+        {
+            IDispatch *disp;
+            hr = IDataSourceLocator_PromptNew(dslocator, &disp);
+        }
 
         IDataInitialize_Release(datainit2);
         IDataInitialize_Release(datainit);
@@ -951,16 +956,16 @@ START_TEST(database)
 {
     OleInitialize(NULL);
 
-    test_database();
+    /*test_database();
     test_errorinfo();
-    test_initializationstring();
+    test_initializationstring();*/
     test_dslocator();
 
     /* row position */
-    test_rowposition();
+    /*test_rowposition();
     test_rowpos_initialize();
     test_rowpos_clearrowposition();
-    test_rowpos_setrowposition();
+    test_rowpos_setrowposition();*/
 
     OleUninitialize();
 }
diff --git a/dlls/oledb32/version.rc b/dlls/oledb32/version.rc
index e082acc..b9b8f02 100644
--- a/dlls/oledb32/version.rc
+++ b/dlls/oledb32/version.rc
@@ -15,6 +15,7 @@
  * License along with this library; if not, write to the Free Software
  * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
  */
+#include "resource.h"
 
 #define WINE_FILEDESCRIPTION_STR "Wine oledb"
 #define WINE_FILENAME_STR "oledb32.dll"
@@ -24,3 +25,23 @@
 #define WINE_PRODUCTVERSION_STR "2.81.1117.0"
 
 #include "wine/wine_common_ver.rc"
+
+#pragma makedep po
+
+LANGUAGE LANG_ENGLISH, SUBLANG_DEFAULT
+
+STRINGTABLE
+{
+    IDS_PROPSHEET_TITLE    "Data Link Properties"
+    IDS_COL_PROVIDER       "OLE DB Provider(s)"
+}
+
+IDD_PROVIDER DIALOG 0, 0, 227, 225
+STYLE DS_SETFONT | WS_CHILD | WS_DISABLED | WS_CAPTION
+CAPTION "Provider"
+FONT 8, "MS Shell Dlg"
+BEGIN
+    LTEXT           "Select the data you want to connect to:",-1,8,7,206,8
+    CONTROL         "List1",IDC_LST_CONNECTIONS,"SysListView32",LVS_REPORT | LVS_SINGLESEL | LVS_SHOWSELALWAYS | LVS_SORTASCENDING | LVS_NOSORTHEADER | WS_BORDER | WS_TABSTOP,14,20,206,162
+    PUSHBUTTON      "&Next >>",IDC_BTN_NEXT,170,194,50,14
+END
-- 
1.9.1

