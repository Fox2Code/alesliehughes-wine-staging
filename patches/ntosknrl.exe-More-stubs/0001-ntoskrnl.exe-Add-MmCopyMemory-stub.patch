From 9244ca1fd01d947d767c85ac5d59aca84d4145b0 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Sun, 18 Jul 2021 17:51:30 +1000
Subject: [PATCH 1/2] ntoskrnl.exe: Add MmCopyMemory stub

---
 dlls/ntoskrnl.exe/ntoskrnl.c        | 11 ++++++++++-
 dlls/ntoskrnl.exe/ntoskrnl.exe.spec |  1 +
 include/ddk/ntddk.h                 | 12 ++++++++++++
 3 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/dlls/ntoskrnl.exe/ntoskrnl.c b/dlls/ntoskrnl.exe/ntoskrnl.c
index 7d0cabc6ba6..83c90c6a1f2 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.c
+++ b/dlls/ntoskrnl.exe/ntoskrnl.c
@@ -2742,7 +2742,6 @@ PVOID WINAPI MmMapIoSpace( PHYSICAL_ADDRESS PhysicalAddress, DWORD NumberOfBytes
     return NULL;
 }
 
-
 /***********************************************************************
  *           MmLockPagableSectionByHandle  (NTOSKRNL.EXE.@)
  */
@@ -4041,6 +4040,16 @@ NTSTATUS WINAPI MmCopyVirtualMemory(PEPROCESS fromprocess, void *fromaddress, PE
     return STATUS_NOT_IMPLEMENTED;
 }
 
+/***********************************************************************
+ *           MmCopyMemory   (NTOSKRNL.EXE.@)
+ */
+NTSTATUS WINAPI MmCopyMemory(void *target, MM_COPY_ADDRESS source, SIZE_T size, ULONG flags, SIZE_T *transferred)
+{
+    FIXME( "stub: %p, %p, %lu, 0x%08x, %p\n", target, source.VirtualAddress, size, flags, transferred );
+    *transferred = 0;
+    return STATUS_NOT_IMPLEMENTED;
+}
+
 /*********************************************************************
  *           KeEnterGuardedRegion    (NTOSKRNL.@)
  */
diff --git a/dlls/ntoskrnl.exe/ntoskrnl.exe.spec b/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
index 622c498d7e8..381576db017 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
+++ b/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
@@ -691,6 +691,7 @@
 @ stdcall MmBuildMdlForNonPagedPool(ptr)
 @ stub MmCanFileBeTruncated
 @ stub MmCommitSessionMappedView
+@ stdcall MmCopyMemory(ptr int64 long long ptr)
 @ stdcall MmCopyVirtualMemory(ptr ptr ptr ptr long long ptr)
 @ stub MmCreateMdl
 @ stdcall MmCreateSection(ptr long ptr ptr long long long ptr)
diff --git a/include/ddk/ntddk.h b/include/ddk/ntddk.h
index 41ad3d721bd..d4dc4c23731 100644
--- a/include/ddk/ntddk.h
+++ b/include/ddk/ntddk.h
@@ -229,6 +229,18 @@ typedef struct _PS_CREATE_NOTIFY_INFO {
     NTSTATUS             CreationStatus;
 } PS_CREATE_NOTIFY_INFO, *PPS_CREATE_NOTIFY_INFO;
 
+typedef struct _MM_COPY_ADDRESS {
+    union {
+        void *VirtualAddress;
+        PHYSICAL_ADDRESS PhysicalAddress;
+    };
+} MM_COPY_ADDRESS, *PMMCOPY_ADDRESS;
+
+#define MM_COPY_MEMORY_PHYSICAL 0x1
+#define MM_COPY_MEMORY_VIRTUAL  0x2
+
+NTSTATUS WINAPI MmCopyMemory (void *target, MM_COPY_ADDRESS source, SIZE_T size, ULONG flags, SIZE_T *transferred);
+
 typedef void (WINAPI *PCREATE_PROCESS_NOTIFY_ROUTINE)(HANDLE,HANDLE,BOOLEAN);
 typedef void (WINAPI *PCREATE_PROCESS_NOTIFY_ROUTINE_EX)(PEPROCESS,HANDLE,PS_CREATE_NOTIFY_INFO*);
 typedef void (WINAPI *PCREATE_THREAD_NOTIFY_ROUTINE)(HANDLE,HANDLE,BOOLEAN);
-- 
2.30.2

