From 64125e9f0d545db67b19656d7859902493f2fe02 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Tue, 19 Apr 2016 09:47:47 +1000
Subject: [PATCH 4/4] inetcomm/tests: Add IMimeMessage SetOption tests

Fixed crash

Signed-off-by: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
---
 dlls/inetcomm/tests/mimeole.c | 63 +++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 63 insertions(+)

diff --git a/dlls/inetcomm/tests/mimeole.c b/dlls/inetcomm/tests/mimeole.c
index 7f72903..d49b831 100644
--- a/dlls/inetcomm/tests/mimeole.c
+++ b/dlls/inetcomm/tests/mimeole.c
@@ -332,6 +332,68 @@ static void test_CreateMessage(void)
     IStream_Release(stream);
 }
 
+void test_MessageOptions(void)
+{
+    static const char string[] = "XXXXX";
+    static const char zero[] =   "0";
+    HRESULT hr;
+    IMimeMessage *msg;
+    PROPVARIANT prop;
+
+    hr = MimeOleCreateMessage(NULL, &msg);
+    ok(hr == S_OK, "ret %08x\n", hr);
+
+    PropVariantInit(&prop);
+
+    prop.vt = VT_BOOL;
+    prop.u.boolVal = TRUE;
+    hr = IMimeMessage_SetOption(msg, OID_HIDE_TNEF_ATTACHMENTS, &prop);
+    ok(hr == S_OK, "ret %08x\n", hr);
+    PropVariantClear(&prop);
+
+    hr = IMimeMessage_GetOption(msg, OID_HIDE_TNEF_ATTACHMENTS, &prop);
+    todo_wine ok(hr == S_OK, "ret %08x\n", hr);
+    todo_wine ok(prop.vt == VT_BOOL, "vt %08x\n", prop.vt);
+    todo_wine ok(prop.u.boolVal == TRUE, "Hide Attachments got %d\n", prop.u.boolVal);
+    PropVariantClear(&prop);
+
+    prop.vt = VT_LPSTR;
+    prop.u.pszVal = CoTaskMemAlloc(strlen(string)+1);
+    strcpy(prop.u.pszVal, string);
+    hr = IMimeMessage_SetOption(msg, OID_HIDE_TNEF_ATTACHMENTS, &prop);
+    todo_wine ok(hr == S_OK, "ret %08x\n", hr);
+    PropVariantClear(&prop);
+
+    hr = IMimeMessage_GetOption(msg, OID_HIDE_TNEF_ATTACHMENTS, &prop);
+    todo_wine ok(hr == S_OK, "ret %08x\n", hr);
+    todo_wine ok(prop.vt == VT_BOOL, "vt %08x\n", prop.vt);
+    todo_wine ok(prop.u.boolVal == TRUE, "Hide Attachments got %d\n", prop.u.boolVal);
+    PropVariantClear(&prop);
+
+    /* Invalid property type doesn't change the value */
+    prop.vt = VT_LPSTR;
+    prop.u.pszVal = CoTaskMemAlloc(strlen(zero)+1);
+    strcpy(prop.u.pszVal, zero);
+    hr = IMimeMessage_SetOption(msg, OID_HIDE_TNEF_ATTACHMENTS, &prop);
+    todo_wine ok(hr == S_OK, "ret %08x\n", hr);
+    PropVariantClear(&prop);
+
+    hr = IMimeMessage_GetOption(msg, OID_HIDE_TNEF_ATTACHMENTS, &prop);
+    todo_wine ok(hr == S_OK, "ret %08x\n", hr);
+    todo_wine ok(prop.vt == VT_BOOL, "vt %08x\n", prop.vt);
+    todo_wine ok(prop.u.boolVal == TRUE, "Hide Attachments got %d\n", prop.u.boolVal);
+    PropVariantClear(&prop);
+
+    /* Invalid OID */
+    prop.vt = VT_BOOL;
+    prop.u.boolVal = TRUE;
+    hr = IMimeMessage_SetOption(msg, 0xff00000a, &prop);
+    todo_wine ok(hr == MIME_E_INVALID_OPTION_ID, "ret %08x\n", hr);
+    PropVariantClear(&prop);
+
+    IMimeMessage_Release(msg);
+}
+
 void test_BindToObject(void)
 {
     HRESULT hr;
@@ -372,6 +434,7 @@ START_TEST(mimeole)
     test_CreateBody();
     test_Allocator();
     test_CreateMessage();
+    test_MessageOptions();
     test_BindToObject();
     test_MimeOleGetPropertySchema();
     OleUninitialize();
-- 
2.8.0.rc3

