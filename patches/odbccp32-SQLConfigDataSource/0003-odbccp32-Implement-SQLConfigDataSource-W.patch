From 6bea1c0a6064af9ccd8e9dd37d264b5c1b7af4fa Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Tue, 7 Aug 2018 14:39:38 +1000
Subject: [PATCH] odbccp32: Implement SQLConfigDataSource/W

WIP: Need to Write a duplicate attribute string functions.
---
 dlls/odbccp32/odbccp32.c | 120 +++++++++++++++++++++++++++++++++++++----------
 1 file changed, 96 insertions(+), 24 deletions(-)

diff --git a/dlls/odbccp32/odbccp32.c b/dlls/odbccp32/odbccp32.c
index 694a90c..cdc8d95 100644
--- a/dlls/odbccp32/odbccp32.c
+++ b/dlls/odbccp32/odbccp32.c
@@ -102,6 +102,22 @@ static inline WCHAR *heap_strdupAtoW(const char *str)
     return ret;
 }
 
+static inline WCHAR *heap_attrdupAtoW(const char *str)
+{
+    LPWSTR ret = NULL;
+
+    if(str) {
+        DWORD len;
+
+        len = MultiByteToWideChar(CP_ACP, 0, str, -1, NULL, 0);
+        ret = heap_alloc_zero( (len+1)*sizeof(WCHAR));
+        if(ret)
+            MultiByteToWideChar(CP_ACP, 0, str, -1, ret, len);
+    }
+
+    return ret;
+}
+
 
 BOOL WINAPI ODBCCPlApplet( LONG i, LONG j, LONG * p1, LONG * p2)
 {
@@ -220,30 +236,6 @@ static BOOL SQLInstall_narrow(int mode, LPSTR buffer, LPCWSTR str, WORD str_leng
     return success;
 }
 
-BOOL WINAPI SQLConfigDataSourceW(HWND hwndParent, WORD fRequest,
-               LPCWSTR lpszDriver, LPCWSTR lpszAttributes)
-{
-    LPCWSTR p;
-
-    clear_errors();
-    FIXME("%p %d %s %s\n", hwndParent, fRequest, debugstr_w(lpszDriver),
-          debugstr_w(lpszAttributes));
-
-    for (p = lpszAttributes; *p; p += lstrlenW(p) + 1)
-        FIXME("%s\n", debugstr_w(p));
-
-    return TRUE;
-}
-
-BOOL WINAPI SQLConfigDataSource(HWND hwndParent, WORD fRequest,
-               LPCSTR lpszDriver, LPCSTR lpszAttributes)
-{
-    FIXME("%p %d %s %s\n", hwndParent, fRequest, debugstr_a(lpszDriver),
-          debugstr_a(lpszAttributes));
-    clear_errors();
-    return TRUE;
-}
-
 static HMODULE load_config_driver(const WCHAR *driver)
 {
     static WCHAR reg_driver[] = {'d','r','i','v','e','r',0};
@@ -360,6 +352,86 @@ fail:
     return FALSE;
 }
 
+BOOL WINAPI SQLConfigDataSourceW(HWND hwndParent, WORD fRequest,
+               LPCWSTR lpszDriver, LPCWSTR lpszAttributes)
+{
+    BOOL (WINAPI *pConfigDSNW)(HWND hwnd, WORD request, const WCHAR *driver, const WCHAR *attr);
+    HMODULE hmod;
+    BOOL ret = FALSE;
+
+    TRACE("%p, %d, %s, %s\n", hwndParent, fRequest, debugstr_w(lpszDriver), debugstr_w(lpszAttributes));
+
+    clear_errors();
+
+    hmod = load_config_driver(lpszDriver);
+    if(!hmod)
+        return FALSE;
+
+    pConfigDSNW = (void*)GetProcAddress(hmod, "ConfigDSNW");
+    if(pConfigDSNW)
+        ret = pConfigDSNW(hwndParent, fRequest, lpszDriver, lpszAttributes);
+
+    if(!ret)
+        push_error(ODBC_ERROR_REQUEST_FAILED, odbc_error_request_failed);
+
+    FreeLibrary(hmod);
+
+    return ret;
+}
+
+BOOL WINAPI SQLConfigDataSource(HWND hwndParent, WORD fRequest,
+               LPCSTR lpszDriver, LPCSTR lpszAttributes)
+{
+    BOOL (WINAPI *pConfigDSN)(HWND hwnd, WORD request, const char *driver, const char *attr);
+    BOOL (WINAPI *pConfigDSNW)(HWND hwnd, WORD request, const WCHAR *driver, const WCHAR *attr);
+    HMODULE hmod;
+    BOOL ret = FALSE;
+    WCHAR *driverW;
+
+    TRACE("%p, %d, %s, %s\n", hwndParent, fRequest, debugstr_a(lpszDriver), debugstr_a(lpszAttributes));
+
+    clear_errors();
+
+    driverW = heap_strdupAtoW(lpszDriver);
+    if(!driverW)
+    {
+        push_error(ODBC_ERROR_OUT_OF_MEM, odbc_error_out_of_mem);
+        return FALSE;
+    }
+
+    hmod = load_config_driver(driverW);
+    if(!hmod)
+    {
+        heap_free(driverW);
+        return FALSE;
+    }
+
+    pConfigDSN = (void*)GetProcAddress(hmod, "ConfigDSN");
+    pConfigDSNW = (void*)GetProcAddress(hmod, "ConfigDSNW");
+    FIXME("ConfigDSN/W %p, %p\n", pConfigDSN, pConfigDSNW);
+    if(pConfigDSN)
+        ret = pConfigDSN(hwndParent, fRequest, lpszDriver, lpszAttributes);
+    else if(pConfigDSNW)
+    {
+        WCHAR *attr = heap_attrdupAtoW(lpszAttributes);
+FIXME("ConfigDSNW %s, %s\n", debugstr_w(driverW), debugstr_w(attr));
+        ret = pConfigDSNW(hwndParent, fRequest, driverW, attr);
+
+        heap_free(attr);
+    }
+
+    if(!ret)
+{
+        FIXME("pConfigDSN failed\n");
+        push_error(ODBC_ERROR_REQUEST_FAILED, odbc_error_request_failed);
+}
+
+    heap_free(driverW);
+    FreeLibrary(hmod);
+
+    return ret;
+}
+
 BOOL WINAPI SQLConfigDriverW(HWND hwnd, WORD request, LPCWSTR driver,
                LPCWSTR args, LPWSTR msg, WORD msgmax, WORD *msgout)
 {
-- 
1.9.1

